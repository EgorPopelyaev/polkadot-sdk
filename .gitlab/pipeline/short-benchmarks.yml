# This file is part of .gitlab-ci.yml
# Here are all jobs that are executed during "short-benchmarks" stage

# Run all pallet benchmarks only once to check if there are any errors

# run short-benchmarks for specified runtime with `frame-omni-bencher`
.short-benchmark: &short-bench
  stage: short-benchmarks
  extends:
    - .common-refs
    - .docker-env
  needs:
    - job: build-frame-omni-bencher
      artifacts: true
  variables:
    PACKAGE_NAME: benchmarked-runtime-chain
    # Enable debug assertions since we are running optimized builds for testing
    # but still want to have debug assertions.
    RUSTFLAGS: "-C debug-assertions -D warnings"
    RUST_BACKTRACE: "full"
    WASM_BUILD_NO_COLOR: 1
    WASM_BUILD_RUSTFLAGS: "-C debug-assertions -D warnings"
  tags:
    - benchmark
  script:
    - RUNTIME_BLOB_NAME=$(echo $PACKAGE_NAME | sed 's/-/_/g').compact.compressed.wasm
    - RUNTIME_BLOB_PATH=./target/release/wbuild/$PACKAGE_NAME/$RUNTIME_BLOB_NAME
    - echo "Running short benchmarking for PACKAGE_NAME=$PACKAGE_NAME and RUNTIME_BLOB_PATH=$RUNTIME_BLOB_PATH"
    - time cargo build --locked --quiet --release -p $PACKAGE_NAME --features runtime-benchmarks
    - ls -lrt $RUNTIME_BLOB_PATH
    - time ./artifacts/frame-omni-bencher v1 benchmark pallet --runtime $RUNTIME_BLOB_PATH --all --steps 2 --repeat 1

short-benchmark-westend-runtime:
  <<: *short-bench
  variables:
    PACKAGE_NAME: westend-runtime

short-benchmark-rococo-runtime:
  <<: *short-bench
  variables:
    PACKAGE_NAME: rococo-runtime

short-benchmark-asset-hub-rococo:
  <<: *short-bench
  variables:
    PACKAGE_NAME: asset-hub-rococo-runtime

short-benchmark-asset-hub-westend:
  <<: *short-bench
  variables:
    PACKAGE_NAME: asset-hub-westend-runtime

short-benchmark-bridge-hub-rococo:
  <<: *short-bench
  variables:
    PACKAGE_NAME: bridge-hub-rococo-runtime

short-benchmark-bridge-hub-westend:
  <<: *short-bench
  variables:
    PACKAGE_NAME: bridge-hub-westend-runtime

short-benchmark-collectives-westend:
  <<: *short-bench
  variables:
    PACKAGE_NAME: collectives-westend-runtime

short-benchmark-contracts-rococo-runtime:
  <<: *short-bench
  variables:
    PACKAGE_NAME: contracts-rococo-runtime

short-benchmark-coretime-rococo:
  <<: *short-bench
  variables:
    PACKAGE_NAME: coretime-rococo-runtime

short-benchmark-coretime-westend:
  <<: *short-bench
  variables:
    PACKAGE_NAME: coretime-westend-runtime

short-benchmark-people-rococo:
  <<: *short-bench
  variables:
    PACKAGE_NAME: people-rococo-runtime

short-benchmark-people-westend:
  <<: *short-bench
  variables:
    PACKAGE_NAME: people-westend-runtime

short-benchmark-glutton-westend:
  <<: *short-bench
  variables:
    PACKAGE_NAME: glutton-westend-runtime
